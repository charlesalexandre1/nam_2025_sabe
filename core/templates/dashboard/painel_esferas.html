{% extends "base.html" %}
{% load painel_tags %}

{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<style>
/* Impress√£o */
    @media print {

    /* Remove cores de fundo e sombras desnecess√°rias */
    * {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        box-shadow: none !important;
        text-shadow: none !important;
    }

    body {
        background: #fff;
        font-size: 8pt;
        margin: 0;
        padding: 0;
    }

    /* Transforma o layout em bloco simples */
    .layout {
        display: block !important;
    }

    .sidebar {
        display: none !important;
    }

    .main {
        width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
    }

    .header {
        display: none !important; /* Oculta o cabe√ßalho com o nome do usu√°rio */
    }

    .boletim-header p {
        margin: 0;
        font-size:8px;
        line-height: 1.1;
        color: #000;
    }

    .content {
        padding: 0 !important;
        margin: 0 !important;
        width: 100% !important;
    }
    }
</style>
  
<div class="container">
    <h2>Comparativo de Desempenho por Esferas - SABE</h2>
        <p>Secretaria Municipal de Educa√ß√£o - Juazeiro</p>
        <p>Superintend√™ncia Pedag√≥gica</p>
        <p>N√∫cleo de Avalia√ß√£o e Monitoramento - NAM</p>
    <!-- Filtros -->
     
<div class="card">
        <form method="get" class="filter-form">
            <div>
                <label for="disciplina">Disciplina:</label>
                <select name="disciplina" id="disciplina">
                    {% for disc in todas_disciplinas %}
                        <option value="{{ disc.id }}" {% if disc.id == disciplina.id %}selected{% endif %}>
                            {{ disc.nome }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="serie">S√©rie/Ano:</label>
                <select name="serie" id="serie">
                    {% for s in todas_series %}
                        <option value="{{ s.id }}" {% if s.id == serie.id %}selected{% endif %}>
                            {{ s.nome }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit">Filtrar</button>
        </form>
    </div>

   
    <!-- Tabela comparativa (esferas x anos) -->
<div class="card">
        <h3> Profici√™ncia M√©dia por Esfera e Ano</h3>
        <p><strong>Disciplina:</strong> {{ disciplina.nome }} | <strong>S√©rie:</strong> {{ serie.nome }}</p>
        {% if anos %}
            <table>
                <thead>
                    <tr>
                        <th>Esfera</th>
                        {% for ano in anos %}
                            <th>{{ ano }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for esfera in esferas %}
                    <tr>
                        <td><strong>{{ esfera.nome }}</strong></td>
                        {% for ano in anos %}
                            {% with desempenho=matriz|dict_key:esfera.id|dict_key:ano %}
                                <td class="{% if desempenho %}text-center{% else %}text-muted text-center{% endif %}">
                                    {% if desempenho %}
                                        {{ desempenho.proficiencia_media|floatformat:1 }}
                                        <span class="small">({{ desempenho.alunos_avaliados }} alunos)</span>
                                    {% else %}
                                        ‚Äî
                                    {% endif %}
                                </td>
                            {% endwith %}
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p class="text-muted">Nenhum dado dispon√≠vel para os filtros selecionados.</p>
        {% endif %}
    </div>

    <!-- Ranking do √∫ltimo ano -->
    {% if ranking %}
    <div class="card">
        <h3>üèÜ Ranking das Esferas em {{ ultimo_ano }}</h3>
        <table>
            <tr>
                <th>Posi√ß√£o</th>
                <th>Esfera</th>
                <th>Profici√™ncia M√©dia</th>
                <th>Alunos Avaliados</th>
                <th>% Abaixo do B√°sico+B√°sico</th>
                <th>% Adequado+Avan√ßado</th>
            </tr>
            {% for item in ranking %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ item.esfera.nome }}</td>
                <td>{{ item.proficiencia_media|floatformat:1 }}</td>
                <td>{{ item.alunos_avaliados }}</td>
                <td>{{ item.soma_ab|floatformat:1 }}%</td>
                <td>{{ item.soma_aa|floatformat:1 }}%</td>
            </tr>
            {% endfor %}
        </table>
    </div>
    {% endif %}

    <!-- Evolu√ß√£o anual (m√©dias gerais) -->
    <div class="card">
        <h3>üìÖ Evolu√ß√£o Anual (M√©dia Geral)</h3>
        <table>
            <tr>
                <th>Ano</th>
                <th>Profici√™ncia M√©dia</th>
                <th>Total de Alunos Avaliados</th>
            </tr>
            {% for item in evolucao %}
            <tr>
                <td>{{ item.ano }}</td>
                <td>{{ item.media_proficiencia|floatformat:1 }}</td>
                <td>{{ item.total_avaliados }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="3" class="text-center text-muted">Nenhum dado encontrado.</td>
            </tr>
            {% endfor %}
        </table>
    </div>

    <!-- Rodap√© explicativo -->
    <div class="card" style="background: #e9ecef;">
        <p class="text-muted">* Os valores representam a profici√™ncia m√©dia por esfera. Use os filtros para alterar disciplina e s√©rie.</p>
    </div>
</div>

<style>
    body { font-family: Arial, sans-serif; background: #f8f9fa; margin: 0; }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    .card { background: white; border-radius: 8px; padding: 20px; margin: 10px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .stats { display: flex; gap: 20px; margin-bottom: 20px; }
    .stat { flex: 1; text-align: center; }
    .stat p { font-size: 2em; font-weight: bold; margin: 10px 0; color: #007bff; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 10px; border: 1px solid #dee2e6; text-align: left; }
    th { background: #e9ecef; font-weight: 600; }
    .filter-form { display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; }
    .filter-form select { padding: 8px; border: 1px solid #ced4da; border-radius: 4px; min-width: 200px; }
    .filter-form button { background: #007bff; color: white; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; }
    .filter-form button:hover { background: #0056b3; }
    .text-center { text-align: center; }
    .text-muted { color: #6c757d; }
    .small { font-size: 0.85em; }
</style>

{% endblock %}