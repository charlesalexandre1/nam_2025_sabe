{% extends "base.html" %}
{% block content %}

<!-- Bibliotecas necess√°rias -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<style>
    .boletim-container {
        max-width: 100%;
        margin: 0 auto;
        background: #fff;
        padding: 10px;
        border-radius: 0;
        box-shadow: none;
    }

    .boletim-header {
        text-align: center;
        margin-bottom: 10px;
        border-bottom: 2px solid #333;
        padding-bottom: 5px;
    }

    .boletim-header h2 {
        margin: 0 0 2px 0;
        font-size: 18px;
        line-height: 1.1;
        color: #000;
    }

    .boletim-header p {
        margin: 0;
        font-size: 12px;
        line-height: 1.1;
        color: #000;
    }

    .info-escola {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 5px;
        margin-bottom: 10px;
        font-size: 12px;
    }

    .info-box {
        background: #f5f5f5;
        padding: 4px 6px;
        border-radius: 3px;
        border: 1px solid #ccc;
    }

    .table-wrapper {
        overflow-x: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
        margin-bottom: 12px;
    }

    th, td {
        border: 1px solid #000;
        padding: 3px 4px;
        text-align: center;
        line-height: 1.0;
        white-space: nowrap;
    }

    th {
        background: #d9d9d9;
        color: #000;
        font-weight: bold;
    }

    h4 {
        margin: 20px 0 10px 0;
        font-size: 14px;
        font-weight: bold;
        text-align: left;
        border-left: 4px solid #2c3e50;
        padding-left: 8px;
    }

    /* Interpreta√ß√£o */
    .interpretacao-box {
        background-color: #f0f7fb;
        border-left: 4px solid #2980b9;
        padding: 12px 16px;
        margin: 20px 0;
        font-size: 13px;
        line-height: 1.5;
        border-radius: 0 6px 6px 0;
    }

    .interpretacao-box p {
        margin: 0 0 8px 0;
    }

    .interpretacao-box ul {
        margin: 0 0 8px 0;
        padding-left: 20px;
    }

    /* Grid de gr√°ficos de pizza */
    .pizza-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }

    .pizza-box {
        border: 1px solid #999;
        padding: 15px;
        border-radius: 8px;
        background-color: #fafafa;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        text-align: center;
        justify-content: center;
        display: flex;
        flex-direction: column;
    }

    .pizza-box canvas {
        width: 100%;
        max-height: 220px;
        margin-bottom: 10px;
    }

    .pizza-box p {
        margin: 5px 0 0;
        font-weight: bold;
        font-size: 13px;
    }

    /* Legenda textual */
    .legenda-valores {
        margin-top: 10px;
        font-size: 11px;
        text-align: left;
        border-top: 1px dashed #ccc;
        padding-top: 8px;
    }

    .legenda-item {
        display: flex;
        align-items: center;
        margin-bottom: 4px;
    }

    .cor-quadrado {
        display: inline-block;
        width: 12px;
        height: 12px;
        margin-right: 6px;
        border: 1px solid rgba(0,0,0,0.1);
    }

    .sem-dados {
        text-align: center;
        color: #999;
        font-style: italic;
        padding: 50px 0;
        background: #f9f9f9;
        border-radius: 8px;
    }

    /* Impress√£o */
    @media print {

    /* Remove cores de fundo e sombras desnecess√°rias */
    * {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        box-shadow: none !important;
        text-shadow: none !important;
    }

    body {
        background: #fff;
        font-size: 8pt;
        margin: 0;
        padding: 0;
    }

    /* Transforma o layout em bloco simples */
    .layout {
        display: block !important;
    }

    .sidebar {
        display: none !important;
    }

    .main {
        width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
    }

    .header {
        display: none !important; /* Oculta o cabe√ßalho com o nome do usu√°rio */
    }

    .boletim-header p {
        margin: 0;
        font-size:8px;
        line-height: 1.1;
        color: #000;
    }

    .content {
        padding: 0 !important;
        margin: 0 !important;
        width: 100% !important;
    }

    /* Ajusta as tabelas para largura total e fonte reduzida */
    table {
        margin:0!important;
        width: 99.9% !important;
        font-size: 10px !important;
        border-collapse: collapse;
        border-width: 1px;
    }

    th, td {
        padding: 2px 3px !important;
    }

    /* Grid de gr√°ficos ocupa toda a largura */
    .pizza-box canvas {
        display: block;
        margin: 0 auto !important;
        max-width: 100% !important;
        height: auto !important;
    }

    /* Garante que o conte√∫do da pizza-box seja centralizado */
    .pizza-box {
        text-align: center !important;
        justify-content: center !important;
        align-items: center !important;   /* centraliza itens transversalmente */
    }

    /* Opcional: reduz o padding para maximizar √°rea do gr√°fico */
    .pizza-box {
        padding: 8px !important;
    }

    .legenda-valores {
        font-size: 8pt !important;
        margin-top: 5px !important;
    }

    .interpretacao-box {
        border: 1px solid #000 !important;
        background: #fff !important;
        margin: 10px 0 !important;
        padding: 8px !important;
        font-size: 8pt !important;
    }

    /* Garante quebras de p√°gina evitem cortar conte√∫do */
    tr, .pizza-box {
        page-break-inside: avoid;
    }

    /* Ajusta cabe√ßalho do boletim */
    .boletim-header h2 {
        font-size: 12pt !important;
    }

    .boletim-header p {
        font-size: 8px;
    }

    h4 {
        font-size: 11px;
    }

    .info-box {
        background: #fff !important;
        border: 1px solid #000 !important;
        padding: 2px 4px !important;
    }

    .info-escola {
        font-size: 11px;
    }

    }
</style>

<div class="boletim-container">

    <!-- Cabe√ßalho -->
    <div class="boletim-header">
        <h2>Boletim de Desempenho - SABE</h2>
        <p>Secretaria Municipal de Educa√ß√£o - Juazeiro</p>
        <p>Superintend√™ncia Pedag√≥gica</p>
        <p>N√∫cleo de Avalia√ß√£o e Monitoramento - NAM</p>
    </div>

    <!-- Dados da escola -->
    <div class="info-escola">
        <div class="info-box"><b>Escola:</b> {{ escola.nome }}</div>
        <div class="info-box"><b>INEP:</b> {{ escola.inep }}</div>
        <div class="info-box"><b>Localidade:</b> {{ escola.localidade }}</div>
        <div class="info-box"><b>Gestor:</b> {{ escola.gestor }}</div>
    </div>

    <!-- T√≠tulo dos gr√°ficos -->
    <h4>Distribui√ß√£o do Padr√£o de Desempenho por Disciplina ({{ ultimo_ano }}) - M√©dia das S√©ries</h4>

    {% if dados_grafico %}
    <!-- Bloco de interpreta√ß√£o autom√°tica -->
    <div class="interpretacao-box">
        <p style="margin: 0 0 8px 0; font-weight: bold;">üìä Como interpretar os gr√°ficos de pizza</p>
        <p style="margin: 0 0 6px 0;">
            Os gr√°ficos abaixo representam a <strong>distribui√ß√£o percentual m√©dia dos alunos por n√≠vel de profici√™ncia</strong> 
            em cada disciplina, considerando <strong>todas as s√©ries da escola no ano de {{ ultimo_ano }}</strong>. 
            Cada fatia corresponde a um n√≠vel:
        </p>
        <table style="margin: 3px 0 8px 0; width: 100%!important; border-collapse: collapse; border: none;">
            <tr>    
                <td style="border: none; text-align: left;margin: 0 0 15px 0">
                    <span style="color:#e74c3c; font-weight:bold;">Abaixo do B√°sico</span> ‚Äì alunos que n√£o atingiram o m√≠nimo esperado.
                </td>
                <td style="border: none; text-align: left;">
                    <span style="color:#3498db; font-weight:bold;">Adequado</span> ‚Äì alunos que demonstram o aprendizado esperado.
                </td>
            </tr>
            <tr>    
                <td style="border: none; text-align: left;">
                    <span style="color:#f39c12; font-weight:bold;">B√°sico</span> ‚Äì alunos com dom√≠nio parcial, mas ainda insuficiente.
                </td>
                <td style="border: none; text-align: left;">
                    <span style="color:#2ecc71; font-weight:bold;">Avan√ßado</span> ‚Äì alunos que superam as expectativas.
                </td>
            </tr>
        </table>

        <p style="margin: 5px 0 0 0;">
            Quanto maior a fatia verde/azul, melhor o desempenho na disciplina. 
            {% if dados_grafico|length >= 2 %}
                Por exemplo, em <strong>{{ dados_grafico.0.disciplina }}</strong> a maior concentra√ß√£o est√° no n√≠vel 
                <strong>
                {% if dados_grafico.0.adequado > dados_grafico.0.avancado %}
                    Adequado ({{ dados_grafico.0.adequado }}%)
                {% else %}
                    Avan√ßado ({{ dados_grafico.0.avancado }}%)
                {% endif %}
                </strong>, 
                enquanto em <strong>{{ dados_grafico.1.disciplina }}</strong> o percentual de alunos abaixo do b√°sico √© de 
                <strong>{{ dados_grafico.1.abaixo_basico }}%</strong>, indicando a necessidade de interven√ß√µes pedag√≥gicas focadas.
            {% else %}
                Observe as diferen√ßas entre as disciplinas para planejar a√ß√µes de melhoria.
            {% endif %}
        </p>
    </div>

    <!-- Grid de gr√°ficos de pizza com legenda textual -->
    <div class="pizza-grid">
        {% for item in dados_grafico %}
        <div class="pizza-box">
            <canvas id="pizza-{{ forloop.counter }}"></canvas>
            <p><strong>{{ item.disciplina }}</strong></p>
            
            <!-- Legenda com os valores num√©ricos -->
            <div class="legenda-valores">
                <div class="legenda-item">
                    <span class="cor-quadrado" style="background:#e74c3c;"></span>
                    <span>Abaixo do B√°sico: <strong>{{ item.abaixo_basico|floatformat:1 }}%</strong></span>
                </div>
                <div class="legenda-item">
                    <span class="cor-quadrado" style="background:#f39c12;"></span>
                    <span>B√°sico: <strong>{{ item.basico|floatformat:1 }}%</strong></span>
                </div>
                <div class="legenda-item">
                    <span class="cor-quadrado" style="background:#3498db;"></span>
                    <span>Adequado: <strong>{{ item.adequado|floatformat:1 }}%</strong></span>
                </div>
                <div class="legenda-item">
                    <span class="cor-quadrado" style="background:#2ecc71;"></span>
                    <span>Avan√ßado: <strong>{{ item.avancado|floatformat:1 }}%</strong></span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="sem-dados">Nenhum dado dispon√≠vel para o gr√°fico.</div>
    {% endif %}

    <!-- Tabela 1: Profici√™ncia M√©dia e Padr√£o -->
    <h4>Profici√™ncia M√©dia e Padr√£o de Desempenho</h4>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th rowspan="2">S√©rie</th>
                    <th rowspan="2">Disciplina</th>
                    {% for ano in anos %}
                        <th colspan="2">{{ ano }}</th>
                    {% endfor %}
                </tr>
                <tr>
                    {% for ano in anos %}
                        <th>Prof.</th>
                        <th>Padr√£o</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for linha in boletim %}
                <tr>
                    <td>{{ linha.serie }}</td>
                    <td>{{ linha.disciplina }}</td>
                    {% for a in linha.anos %}
                        <td>{{ a.proficiencia|default:"-"|floatformat:1 }}</td>
                        <td>{{ a.padrao|default:"-" }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Tabela 2: Distribui√ß√£o Percentual por N√≠vel -->
    <h4>Distribui√ß√£o Percentual por N√≠vel de Aprendizagem</h4>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th rowspan="2">S√©rie</th>
                    <th rowspan="2">Disciplina</th>
                    {% for ano in anos %}
                        <th colspan="4">{{ ano }}</th>
                    {% endfor %}
                </tr>
                <tr>
                    {% for ano in anos %}
                        <th>AB</th>
                        <th>B</th>
                        <th>A</th>
                        <th>AV</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for linha in distribuicao %}
                <tr>
                    <td>{{ linha.serie }}</td>
                    <td>{{ linha.disciplina }}</td>
                    {% for a in linha.anos %}
                        <td>{{ a.abaixo_basico|floatformat:1 }}</td>
                        <td>{{ a.basico|floatformat:1 }}</td>
                        <td>{{ a.adequado|floatformat:1 }}</td>
                        <td>{{ a.avancado|floatformat:1 }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>

<!-- Dados do gr√°fico em JSON -->
{{ dados_grafico|json_script:"dados-grafico" }}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dadosElement = document.getElementById('dados-grafico');
        if (!dadosElement) return;

        let dados;
        try {
            dados = JSON.parse(dadosElement.textContent);
        } catch (e) {
            console.error('Erro ao parsear dados:', e);
            return;
        }

        if (!dados || dados.length === 0) return;

        const cores = ['#e74c3c', '#f39c12', '#3498db', '#2ecc71']; // AB, B, A, AV

        dados.forEach((item, index) => {
            const canvasId = `pizza-${index+1}`;
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            new Chart(canvas.getContext('2d'), {
                type: 'pie',
                data: {
                    labels: ['Abaixo do B√°sico', 'B√°sico', 'Adequado', 'Avan√ßado'],
                    datasets: [{
                        data: [
                            item.abaixo_basico,
                            item.basico,
                            item.adequado,
                            item.avancado
                        ],
                        backgroundColor: cores,
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { boxWidth: 10, font: { size: 9 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percent = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value.toFixed(1)}% (${percent}%)`;
                                }
                            }
                        },
                        datalabels: {
                            display: true,
                            color: '#fff',
                            formatter: (value, context) => {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percent = ((value / total) * 100).toFixed(1);
                                return percent + '%';
                            },
                            font: { weight: 'bold', size: 10 }
                        }
                    }
                }
            });
        });
    });
</script>

{% endblock %}